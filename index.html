<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SolidWorks G-code → “New and Working” (Diff Highlight)</title>
  <style>
    :root{
      --bg:#0b0e14; --card:#121826; --text:#e6e9ef; --muted:#a9b1c3;
      --accent:#7aa2f7; --ok:#9ece6a; --bad:#f7768e;
      --codebg:#0f1422; --border:rgba(255,255,255,.12);
      --hl: rgba(250, 211, 100, .25); /* highlight background */
      --hl2: rgba(247, 118, 142, .18); /* "replaced" stronger tint */
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px; }
    h1{ margin:0 0 8px; font-size:22px; }
    p{ margin:0 0 14px; color:var(--muted); line-height:1.45; }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; margin:14px 0; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button{ cursor:pointer; border:0; border-radius:12px; padding:10px 12px; font-weight:700; background:var(--accent); color:#0b0e14; }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    .ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18); }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:var(--muted); font-size:12px; }
    .pill.ok{ color:var(--ok); border-color:rgba(158,206,106,.35); }
    .pill.bad{ color:var(--bad); border-color:rgba(247,118,142,.35); }

    input[type="file"]{ width:100%; }
    .small{ font-size:12px; color:var(--muted); }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .split{ grid-template-columns:1fr; } }

    .panelTitle{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .panelTitle strong{ font-size:13px; }
    .codeWrap{
      background:var(--codebg);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:auto;
      max-height: 520px;
    }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.5;
      padding:10px 0;
      min-width: 520px;
    }
    .line{
      display:flex;
      white-space:pre;
    }
    .ln{
      width:56px;
      text-align:right;
      padding:0 10px 0 0;
      user-select:none;
      color:rgba(169,177,195,.55);
      border-right:1px solid rgba(255,255,255,.06);
      margin-right:10px;
      flex:0 0 auto;
    }
    .txt{ padding-right:12px; }
    .hl{ background:var(--hl); }
    .hl2{ background:var(--hl2); }
    .log{
      white-space:pre-wrap;
      color:var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi span{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px; padding:6px 10px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>SolidWorks G-code → “New and Working” (shows exact changes)</h1>
  <p>
    Upload a SolidWorks-exported lathe program, convert it, and download the result.
    The <b>right pane highlights</b> every line that changed or was inserted.
    Tool changes are forced to <b>M06T0707 style (no spaces)</b>. Only tools <b>01–08</b> are allowed.
  </p>

  <div class="card">
    <div class="row">
      <div style="flex: 1 1 480px;">
        <label class="small">Input file (.nc, .tap, .txt, .gcode)</label>
        <input id="file" type="file" accept=".nc,.tap,.txt,.gcode" />
      </div>
      <div style="flex:0 0 320px;">
        <label class="small">Output name</label>
        <input id="outname" type="text" style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1422; color:var(--text);" placeholder="new_and_working.nc"/>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="convert" disabled>Convert</button>
      <button id="download" class="ghost" disabled>Download Converted</button>
      <button id="clear" class="ghost">Clear</button>
      <span id="status" class="pill">Waiting for file…</span>
    </div>

    <div class="kpi">
      <span id="kpiChanged">Changed lines: —</span>
      <span id="kpiInserted">Inserted lines: —</span>
      <span id="kpiWarnings">Warnings: —</span>
    </div>

    <p class="small" style="margin-top:10px;">
      Runs locally in your browser. GitHub Pages cannot read/write your disk directly, so you upload + download.
    </p>
  </div>

  <div class="card">
    <div class="split">
      <div>
        <div class="panelTitle">
          <strong>Original (SolidWorks)</strong>
          <span class="pill">No highlights</span>
        </div>
        <div class="codeWrap"><div id="origView" class="code"></div></div>
      </div>

      <div>
        <div class="panelTitle">
          <strong>Converted (“new and working”)</strong>
          <span class="pill ok">Highlights on</span>
        </div>
        <div class="codeWrap"><div id="newView" class="code"></div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="panelTitle">
      <strong>Conversion log</strong>
      <span class="pill">What changed & why</span>
    </div>
    <div id="log" class="log">—</div>
  </div>
</div>

<script>
/**
 * ========= Conversion rules =========
 * - Remove N line numbers (N1, N2, N70, etc.) from the converted file
 * - Convert "[BILLET ..." -> "(BILLET ...)"
 * - Remove G54 tokens
 * - Replace any line containing X508 and Z127 with:
 *     M09
 *     G28 U0 W0
 * - Remove cutoff/part-off block (since you part off by hand)
 * - If out-of-range tools are found (anything not 01–08), prompt the user to SWAP them to a tool 01–08
 * - For every tool line, inject:
 *     M05
 *     M00 (...)  (manual stop)
 *     M06Tnnmm   (NO SPACE, matches proprietary style)
 * - Normalize program ending:
 *     M05
 *     M00 (PROGRAM END - PART OFF BY HAND)
 *     M30
 */

const TOOL_LINE_RE = /^\s*(?:M06\s*)?T(\d{2})(\d{2})\s*$/i;
const HAS_BILLET_RE = /^\s*\[BILLET\b/i;

function pad2(n){ return String(n).padStart(2,"0"); }

function stripNLineNumber(line, log){
  // Remove leading N-codes like: "N1 ..." "N70..." "N0030 ..."
  // Only at start of line (ignoring whitespace), and only if followed by whitespace or end.
  const before = line;
  const after = line.replace(/^\s*N\d+\s*/i, "");
  if (after !== before) log.push("Removed N line number (N###) from start of line");
  return after;
}

function normalizeBILLET(line, log){
  if (HAS_BILLET_RE.test(line)) {
    const content = line.trim().slice(1).trim(); // drop '['
    log.push("Converted [BILLET … to (BILLET …) (safer comment syntax)");
    return `(${content})\n`;
  }
  return line;
}

function removeG54(line, log){
  if (/\bG54\b/i.test(line)) log.push("Removed G54 (controller was faulting on work offset)");
  return line.replace(/\bG54\b\s*/ig, "");
}

function replaceFarRetract(lines, log){
  const out = [];
  for (const line of lines) {
    const hasX508 = /\bX\s*508(\.0*)?\b/i.test(line);
    const hasZ127 = /\bZ\s*127(\.0*)?\b/i.test(line);
    if (hasX508 && hasZ127) {
      log.push("Replaced X508/Z127 retract (overtravel) with M09 + G28 U0 W0");
      out.push("M09\n");
      out.push("G28 U0 W0\n");
    } else {
      out.push(line.endsWith("\n") ? line : line + "\n");
    }
  }
  return out;
}

function stripCutoffBlock(lines, log){
  let startIdx = null;

  for (let i=0;i<lines.length;i++){
    const u = lines[i].toUpperCase();
    if (u.includes("(3MM CUT-OFF") || u.includes("( CUT OFF") || u.includes("(PART OFF")) {
      startIdx = i; break;
    }
  }

  // fallback: late T0707/T0909-ish tool call (rare)
  if (startIdx === null) {
    for (let i=lines.length-1;i>=0;i--){
      if (/^\s*(?:M06\s*)?T(07|09)(07|09)\s*$/i.test(lines[i])) { startIdx = i; break; }
    }
  }

  if (startIdx === null) return lines;
  log.push("Removed cutoff/part-off block (you’re parting off by hand)");
  return lines.slice(0, startIdx);
}

function insertManualStopsForceM06NoSpace(lines, log){
  const out = [];
  let firstToolSeen = false;

  for (const raw of lines){
    const line = raw.endsWith("\n") ? raw : raw + "\n";
    const m = raw.match(TOOL_LINE_RE);

    if (m){
      const tool = parseInt(m[1], 10);
      const off  = parseInt(m[2], 10);

      out.push("M05\n");
      if (!firstToolSeen){
        out.push(`M00 (LOAD TOOL ${tool} - T${pad2(tool)}${pad2(off)}, THEN CYCLE START)\n`);
        firstToolSeen = true;
        log.push(`Inserted mandatory stop for initial tool load (Tool ${tool})`);
      } else {
        out.push(`M00 (MANUAL TOOL CHANGE: LOAD TOOL ${tool} - T${pad2(tool)}${pad2(off)}, THEN CYCLE START)\n`);
        log.push(`Inserted mandatory manual tool-change stop (Tool ${tool})`);
      }

      // IMPORTANT: proprietary style, NO SPACE:
      out.push(`M06T${pad2(tool)}${pad2(off)}\n`);
      continue;
    }

    out.push(line);
  }

  return out;
}

function ensureProgramEnd(lines, log){
  while (lines.length && lines[lines.length-1].trim()==="") lines.pop();
  if (lines.length && lines[lines.length-1].trim().toUpperCase()==="M30") lines.pop();

  lines.push("M05\n");
  lines.push("M00 (PROGRAM END - PART OFF BY HAND)\n");
  lines.push("M30\n");
  log.push("Normalized ending: M05, M00 (end note), M30");
  return lines;
}

/** ---------- Tool swap UI + logic ---------- */

function scanToolCalls(lines){
  const found = [];
  const re = /\b(?:M06\s*)?T(\d{2})(\d{2})\b/ig;

  for (let i = 0; i < lines.length; i++){
    const line = lines[i];
    let m;
    while ((m = re.exec(line)) !== null){
      const tool = parseInt(m[1], 10);
      const off  = parseInt(m[2], 10);
      found.push({ tool, off, lineNo: i + 1, raw: m[0] });
    }
  }
  return found;
}

function getOutOfRangeTools(toolCalls){
  const map = new Map();
  for (const t of toolCalls){
    if (t.tool > 8 || t.tool < 1){
      if (!map.has(t.tool)) map.set(t.tool, t.lineNo);
    }
  }
  return [...map.entries()].map(([tool, lineNo]) => ({ tool, lineNo }));
}

function renderToolSwapUI(outOfRangeTools){
  const rows = outOfRangeTools.map(({tool, lineNo}) => {
    const options = Array.from({length: 8}, (_, i) => {
      const v = String(i + 1).padStart(2, "0");
      const selected = (tool === 9 && v === "07") || (tool !== 9 && v === "01") ? "selected" : "";
      return `<option value="${v}" ${selected}>Tool ${v}</option>`;
    }).join("");

    const tStr = String(tool).padStart(2, "0");
    return `
      <div style="display:flex; gap:10px; align-items:center; margin:8px 0; flex-wrap:wrap;">
        <div style="min-width:320px;">
          <b>Found Tool ${tStr} (out of range)</b>
          <span style="color: var(--muted);">— first seen near line ${lineNo}</span>
        </div>
        <div>
          <label style="color: var(--muted); font-size:12px; margin-right:6px;">Swap to:</label>
          <select data-swap-from="${tStr}"
            style="padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0f1422; color:var(--text);">
            ${options}
          </select>
        </div>
      </div>
    `;
  }).join("");

  return `
    <div style="margin-top:6px;">
      <div class="pill bad" style="display:inline-block; margin-bottom:10px;">
        Conversion paused — tool(s) out of range
      </div>
      <div style="color: var(--muted); margin-bottom:10px;">
        Your machine supports only tools <b>01–08</b>. Choose how to swap each out-of-range tool.
        We will convert <b>Tnnmm → Txxxx</b> so tool and offset match (example: <b>T0909 → T0707</b>).
      </div>
      ${rows}
      <button id="applySwaps" style="margin-top:10px;">Apply swaps & convert</button>
    </div>
  `;
}

function applyToolSwapsToLines(lines, toolSwapMap, log){
  const out = [];
  const re = /\b(M06\s*)?T(\d{2})(\d{2})\b/ig;

  for (let i = 0; i < lines.length; i++){
    const original = lines[i];
    const updated = original.replace(re, (match, m06Part, toolStr, offStr) => {
      const tool = parseInt(toolStr, 10);
      const mapped = toolSwapMap[tool];
      if (mapped == null) return match;

      const nt = String(mapped).padStart(2, "0");
      const repl = (m06Part != null) ? `M06T${nt}${nt}` : `T${nt}${nt}`;
      return repl;
    });

    if (updated !== original){
      out.push(updated);
      log.push(`Applied tool swap(s) on/near line ${i+1}`);
    } else {
      out.push(original);
    }
  }
  return out;
}

function runConversionWithSwaps(toolSwapMap){
  const log = [];
  let lines = originalText.split(/\r?\n/).map(l => l + "\n");

  // Apply user swaps first
  if (toolSwapMap){
    lines = applyToolSwapsToLines(lines, toolSwapMap, log);
  }

  // Remove N line numbers early so everything downstream sees clean lines
  lines = lines.map(l => stripNLineNumber(l, log));

  lines = lines.map(l => normalizeBILLET(l, log));
  lines = lines.map(l => removeG54(l, log));
  lines = replaceFarRetract(lines, log);
  lines = stripCutoffBlock(lines, log);
  lines = insertManualStopsForceM06NoSpace(lines, log);
  lines = ensureProgramEnd(lines, log);

  // Deduplicate spammy "Removed N line number..." messages
  const deduped = [];
  let nRemovedCount = 0;
  for (const entry of log){
    if (entry === "Removed N line number (N###) from start of line"){
      nRemovedCount++;
    } else {
      deduped.push(entry);
    }
  }
  if (nRemovedCount > 0) deduped.unshift(`Removed N line numbers (N###) from ${nRemovedCount} line(s)`);

  return { out: lines.join(""), log: deduped };
}

/**
 * ========= Diff highlighting (right side only) =========
 */
function myersDiff(aLines, bLines){
  const N = aLines.length, M = bLines.length;
  const max = N + M;
  const v = new Map();
  v.set(1, 0);
  const trace = [];

  for (let d=0; d<=max; d++){
    const vSnapshot = new Map(v);
    trace.push(vSnapshot);

    for (let k=-d; k<=d; k+=2){
      let x;
      if (k === -d || (k !== d && (v.get(k-1) ?? -1) < (v.get(k+1) ?? -1))){
        x = v.get(k+1) ?? 0;
      } else {
        x = (v.get(k-1) ?? 0) + 1;
      }
      let y = x - k;

      while (x < N && y < M && aLines[x] === bLines[y]) { x++; y++; }

      v.set(k, x);

      if (x >= N && y >= M) {
        return backtrack(trace, aLines, bLines);
      }
    }
  }
  return [];
}

function backtrack(trace, aLines, bLines){
  let x = aLines.length;
  let y = bLines.length;
  const edits = [];

  for (let d=trace.length-1; d>=0; d--){
    const v = trace[d];
    const k = x - y;

    let prevK;
    if (k === -d || (k !== d && (v.get(k-1) ?? -1) < (v.get(k+1) ?? -1))){
      prevK = k + 1;
    } else {
      prevK = k - 1;
    }

    const prevX = v.get(prevK) ?? 0;
    const prevY = prevX - prevK;

    while (x > prevX && y > prevY){
      edits.push({type:"equal", aIndex:x-1, bIndex:y-1});
      x--; y--;
    }

    if (d === 0) break;

    if (x === prevX){
      edits.push({type:"insert", bIndex:y-1});
      y--;
    } else {
      edits.push({type:"delete", aIndex:x-1});
      x--;
    }
  }

  edits.reverse();
  return edits;
}

function computeHighlightFlags(origText, newText){
  const a = origText.split(/\r?\n/);
  const b = newText.split(/\r?\n/);

  const edits = myersDiff(a, b);

  const hl = new Array(b.length).fill(null);
  for (let i=0;i<edits.length;i++){
    if (edits[i].type === "insert" && edits[i].bIndex != null){
      hl[edits[i].bIndex] = "insert";
    }
  }
  for (let i=0;i<edits.length-1;i++){
    if (edits[i].type === "delete" && edits[i+1].type === "insert"){
      const bi = edits[i+1].bIndex;
      if (bi != null) hl[bi] = "replace";
    }
  }

  let inserted = hl.filter(x => x === "insert").length;
  let replaced = hl.filter(x => x === "replace").length;

  return { flags: hl, inserted, replaced };
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function renderCode(container, text, highlightFlags=null){
  const lines = text.split(/\r?\n/);
  container.innerHTML = "";

  for (let i=0;i<lines.length;i++){
    const lineDiv = document.createElement("div");
    lineDiv.className = "line";

    const ln = document.createElement("span");
    ln.className = "ln";
    ln.textContent = String(i+1);

    const txt = document.createElement("span");
    let cls = "txt";
    if (highlightFlags && highlightFlags[i]) {
      cls += (highlightFlags[i] === "replace") ? " hl2" : " hl";
    }
    txt.className = cls;
    txt.innerHTML = escapeHtml(lines[i] ?? "");
    lineDiv.appendChild(ln);
    lineDiv.appendChild(txt);
    container.appendChild(lineDiv);
  }
}

// ---------------- UI wiring ----------------
const fileEl = document.getElementById("file");
const convertBtn = document.getElementById("convert");
const downloadBtn = document.getElementById("download");
const clearBtn = document.getElementById("clear");
const statusEl = document.getElementById("status");
const outnameEl = document.getElementById("outname");
const origView = document.getElementById("origView");
const newView  = document.getElementById("newView");
const logEl    = document.getElementById("log");
const kpiChanged = document.getElementById("kpiChanged");
const kpiInserted = document.getElementById("kpiInserted");
const kpiWarnings = document.getElementById("kpiWarnings");

let originalText = "";
let convertedText = "";
let convertedBlob = null;

function setStatus(text, kind=""){
  statusEl.textContent = text;
  statusEl.className = "pill" + (kind ? ` ${kind}` : "");
}

fileEl.addEventListener("change", async (e) => {
  convertedBlob = null;
  downloadBtn.disabled = true;
  convertBtn.disabled = true;
  convertedText = "";
  logEl.textContent = "—";

  kpiChanged.textContent = "Changed lines: —";
  kpiInserted.textContent = "Inserted lines: —";
  kpiWarnings.textContent = "Warnings: —";

  const f = e.target.files?.[0];
  if (!f){
    originalText = "";
    renderCode(origView, "");
    renderCode(newView, "");
    setStatus("Waiting for file…");
    return;
  }

  setStatus("Loading file…","ok");
  originalText = await f.text();

  renderCode(origView, originalText);
  renderCode(newView, "");

  const base = f.name.replace(/\.[^/.]+$/, "");
  const ext = (f.name.match(/\.[^/.]+$/) || [".nc"])[0];
  outnameEl.value = `${base}_new_and_working${ext}`;

  convertBtn.disabled = false;
  setStatus("Ready to convert","ok");
});

convertBtn.addEventListener("click", () => {
  if (!originalText.trim()) return;

  setStatus("Converting…","ok");
  logEl.textContent = "—";

  try{
    const srcLines = originalText.split(/\r?\n/).map(l => l + "\n");
    const toolCalls = scanToolCalls(srcLines);
    const outOfRange = getOutOfRangeTools(toolCalls);

    if (outOfRange.length > 0){
      logEl.innerHTML = renderToolSwapUI(outOfRange);
      kpiWarnings.textContent = `Warnings: 1`;
      kpiChanged.textContent = `Changed lines: —`;
      kpiInserted.textContent = `Inserted lines: —`;
      setStatus("Conversion paused — choose swaps","bad");

      const btn = document.getElementById("applySwaps");
      btn.addEventListener("click", () => {
        const selects = logEl.querySelectorAll("select[data-swap-from]");
        const swapMap = {};
        selects.forEach(sel => {
          const from = parseInt(sel.getAttribute("data-swap-from"), 10);
          const to = parseInt(sel.value, 10);
          swapMap[from] = to;
        });

        try {
          const { out, log } = runConversionWithSwaps(swapMap);
          convertedText = out;

          const { flags, inserted, replaced } = computeHighlightFlags(originalText, convertedText);
          renderCode(newView, convertedText, flags);

          const changed = inserted + replaced;
          kpiChanged.textContent = `Changed lines: ${changed}`;
          kpiInserted.textContent = `Inserted lines: ${inserted}`;
          kpiWarnings.textContent = `Warnings: 0`;

          logEl.textContent = log.length ? log.map(x => `• ${x}`).join("\n") : "No changes detected.";
          convertedBlob = new Blob([convertedText], { type: "text/plain" });
          downloadBtn.disabled = false;
          setStatus("Converted ✓","ok");
        } catch (err2){
          convertedBlob = null;
          downloadBtn.disabled = true;
          renderCode(newView, "");
          logEl.textContent = String(err2?.message || err2);
          kpiWarnings.textContent = `Warnings: 1`;
          setStatus("Conversion blocked","bad");
        }
      });

      return;
    }

    const { out, log } = runConversionWithSwaps(null);
    convertedText = out;

    const { flags, inserted, replaced } = computeHighlightFlags(originalText, convertedText);
    renderCode(newView, convertedText, flags);

    const changed = inserted + replaced;
    kpiChanged.textContent = `Changed lines: ${changed}`;
    kpiInserted.textContent = `Inserted lines: ${inserted}`;
    kpiWarnings.textContent = `Warnings: 0`;

    logEl.textContent = log.length ? log.map(x => `• ${x}`).join("\n") : "No changes detected.";
    convertedBlob = new Blob([convertedText], { type: "text/plain" });
    downloadBtn.disabled = false;
    setStatus("Converted ✓","ok");

  } catch (err){
    convertedBlob = null;
    downloadBtn.disabled = true;
    renderCode(newView, "");
    logEl.textContent = String(err?.message || err);
    kpiWarnings.textContent = `Warnings: 1`;
    setStatus("Conversion blocked","bad");
  }
});

downloadBtn.addEventListener("click", () => {
  if (!convertedBlob) return;
  const name = (outnameEl.value || "new_and_working.nc").trim();

  const url = URL.createObjectURL(convertedBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

clearBtn.addEventListener("click", () => {
  fileEl.value = "";
  originalText = "";
  convertedText = "";
  convertedBlob = null;
  convertBtn.disabled = true;
  downloadBtn.disabled = true;
  outnameEl.value = "";
  renderCode(origView, "");
  renderCode(newView, "");
  logEl.textContent = "—";
  kpiChanged.textContent = "Changed lines: —";
  kpiInserted.textContent = "Inserted lines: —";
  kpiWarnings.textContent = "Warnings: —";
  setStatus("Waiting for file…");
});
</script>
</body>
</html>
