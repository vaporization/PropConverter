<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SolidWorks G-code → “New and Working” Converter</title>
  <style>
    :root { --bg:#0b0e14; --card:#121826; --text:#e6e9ef; --muted:#a9b1c3; --accent:#7aa2f7; --ok:#9ece6a; --warn:#f7768e; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width:980px; margin:0 auto; padding:24px; }
    h1 { margin:0 0 8px; font-size:22px; }
    p { margin:0 0 14px; color:var(--muted); line-height:1.4; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; margin:14px 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }
    button { cursor:pointer; border:0; border-radius:12px; padding:10px 12px; font-weight:650; background:var(--accent); color:#0b0e14; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .ghost { background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18); }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:var(--muted); font-size:12px; }
    textarea { width:100%; min-height:220px; background:#0f1422; border:1px solid rgba(255,255,255,.12); border-radius:12px; color:var(--text); padding:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .log { white-space:pre-wrap; color:var(--muted); font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .ok { color:var(--ok); }
    .warn { color:var(--warn); }
    input[type="file"] { width:100%; }
    .small { font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SolidWorks G-code → “New and Working”</h1>
    <p>
      Upload a SolidWorks-exported lathe G-code file and download a converted version that matches your controller expectations:
      <span class="pill">forces M06 tool changes</span>
      <span class="pill">manual stops (M00)</span>
      <span class="pill">removes G54</span>
      <span class="pill">replaces X508/Z127 retract</span>
      <span class="pill">removes cutoff block</span>
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label class="small">Input file (.nc, .tap, .txt, .gcode)</label>
          <input id="file" type="file" accept=".nc,.tap,.txt,.gcode" />
        </div>
        <div style="flex:0 0 auto; min-width:220px;">
          <label class="small">Output name</label>
          <input id="outname" type="text" style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1422; color:var(--text);" placeholder="new_and_working.nc"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="convert" disabled>Convert</button>
        <button id="download" class="ghost" disabled>Download Converted</button>
        <button id="clear" class="ghost">Clear</button>
      </div>

      <p class="small" style="margin-top:10px;">
        Note: This runs entirely in your browser (no uploads to a server). GitHub Pages can’t access your disk directly, so you upload + download.
      </p>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-start;">
        <div>
          <label class="small">Input preview</label>
          <textarea id="input" placeholder="Input file will appear here…" readonly></textarea>
        </div>
        <div>
          <label class="small">Converted output</label>
          <textarea id="output" placeholder="Converted output will appear here…" readonly></textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div><strong>Conversion log</strong></div>
        <div id="status" class="pill">Waiting for file…</div>
      </div>
      <div id="log" class="log" style="margin-top:10px;">—</div>
    </div>
  </div>

<script>
  // --------------------------
  // Converter logic (JS)
  // Mirrors your "new and working" rules.
  // --------------------------

  const TOOL_LINE_RE = /^\s*(?:M06\s*)?T(\d{2})(\d{2})\s*$/i;
  const HAS_BILLET_RE = /^\s*\[BILLET\b/i;

  function normalizeBILLET(line, log) {
    if (HAS_BILLET_RE.test(line)) {
      const content = line.trim().slice(1).trim(); // drop '['
      log.push("Converted [BILLET ... to (BILLET ...)");
      return `(${content})\n`;
    }
    return line;
  }

  function removeG54(line, log) {
    if (/\bG54\b/i.test(line)) log.push("Removed G54 from a motion line");
    return line.replace(/\bG54\b\s*/ig, "");
  }

  function replaceFarRetract(lines, log) {
    const out = [];
    for (const line of lines) {
      const hasX508 = /\bX\s*508(\.0*)?\b/i.test(line);
      const hasZ127 = /\bZ\s*127(\.0*)?\b/i.test(line);
      if (hasX508 && hasZ127) {
        log.push("Replaced X508/Z127 retract with M09 + G28 U0 W0 (limits-safe)");
        out.push("M09\n");
        out.push("G28 U0 W0\n");
      } else {
        out.push(line.endsWith("\n") ? line : line + "\n");
      }
    }
    return out;
  }

  function stripCutoffBlock(lines, log) {
    let startIdx = null;

    for (let i = 0; i < lines.length; i++) {
      const u = lines[i].toUpperCase();
      if (u.includes("(3MM CUT-OFF") || u.includes("( CUT OFF") || u.includes("(PART OFF")) {
        startIdx = i;
        break;
      }
    }

    if (startIdx === null) {
      for (let i = lines.length - 1; i >= 0; i--) {
        if (/^\s*(?:M06\s*)?T(07|09)(07|09)\s*$/i.test(lines[i])) {
          startIdx = i;
          break;
        }
      }
    }

    if (startIdx === null) return lines;

    log.push("Removed cutoff/part-off block (you’re parting off by hand)");
    return lines.slice(0, startIdx);
  }

  function insertManualStopsForceM06(lines, log) {
    const out = [];
    let firstToolSeen = false;

    for (const lineRaw of lines) {
      const line = lineRaw.endsWith("\n") ? lineRaw : lineRaw + "\n";
      const m = lineRaw.match(TOOL_LINE_RE);

      if (m) {
        const tool = parseInt(m[1], 10);
        const off = parseInt(m[2], 10);

        out.push("M05\n");
        if (!firstToolSeen) {
          out.push(`M00 (LOAD TOOL ${tool} - T${String(tool).padStart(2,"0")}${String(off).padStart(2,"0")}, THEN CYCLE START)\n`);
          log.push(`Inserted initial manual load stop for tool ${tool} (forced M06)`);
          firstToolSeen = true;
        } else {
          out.push(`M00 (MANUAL TOOL CHANGE: LOAD TOOL ${tool} - T${String(tool).padStart(2,"0")}${String(off).padStart(2,"0")}, THEN CYCLE START)\n`);
          log.push(`Inserted manual tool-change stop for tool ${tool} (forced M06)`);
        }

        out.push(`M06 T${String(tool).padStart(2,"0")}${String(off).padStart(2,"0")}\n`);
        continue;
      }

      out.push(line);
    }
    return out;
  }

  function ensureProgramEnd(lines, log) {
    // trim trailing blanks
    while (lines.length && lines[lines.length - 1].trim() === "") lines.pop();

    // remove trailing M30 if present
    if (lines.length && lines[lines.length - 1].trim().toUpperCase() === "M30") lines.pop();

    lines.push("M05\n");
    lines.push("M00 (PROGRAM END - PART OFF BY HAND)\n");
    lines.push("M30\n");
    log.push("Normalized program ending (M05, M00 end note, M30)");
    return lines;
  }

  function convertText(src) {
    const log = [];
    let lines = src.split(/\r?\n/).map(l => l + "\n");
    lines = lines.map(l => normalizeBILLET(l, log));
    lines = lines.map(l => removeG54(l, log));
    lines = replaceFarRetract(lines, log);
    lines = stripCutoffBlock(lines, log);
    lines = insertManualStopsForceM06(lines, log);
    lines = ensureProgramEnd(lines, log);
    return { out: lines.join(""), log };
  }

  // --------------------------
  // UI wiring
  // --------------------------

  const fileEl = document.getElementById("file");
  const convertBtn = document.getElementById("convert");
  const downloadBtn = document.getElementById("download");
  const clearBtn = document.getElementById("clear");
  const inputTa = document.getElementById("input");
  const outputTa = document.getElementById("output");
  const logEl = document.getElementById("log");
  const statusEl = document.getElementById("status");
  const outnameEl = document.getElementById("outname");

  let convertedBlob = null;

  function setStatus(text, ok=true) {
    statusEl.textContent = text;
    statusEl.className = "pill " + (ok ? "ok" : "warn");
  }

  fileEl.addEventListener("change", async (e) => {
    convertedBlob = null;
    downloadBtn.disabled = true;
    outputTa.value = "";
    logEl.textContent = "—";
    setStatus("Loading file…", true);

    const f = e.target.files?.[0];
    if (!f) {
      inputTa.value = "";
      convertBtn.disabled = true;
      setStatus("Waiting for file…", true);
      return;
    }

    const text = await f.text();
    inputTa.value = text.slice(0, 200000); // keep UI responsive
    convertBtn.disabled = false;

    // suggest output name
    const base = f.name.replace(/\.[^/.]+$/, "");
    const ext = (f.name.match(/\.[^/.]+$/) || [".nc"])[0];
    outnameEl.value = `${base}_new_and_working${ext}`;

    setStatus("Ready to convert", true);
  });

  convertBtn.addEventListener("click", () => {
    const src = inputTa.value;
    if (!src.trim()) return;

    setStatus("Converting…", true);

    const { out, log } = convertText(src);
    outputTa.value = out.slice(0, 200000);

    convertedBlob = new Blob([out], { type: "text/plain" });
    downloadBtn.disabled = false;

    logEl.textContent = log.length ? log.map(x => `• ${x}`).join("\n") : "No changes detected.";

    setStatus("Converted ✓", true);
  });

  downloadBtn.addEventListener("click", () => {
    if (!convertedBlob) return;
    const name = (outnameEl.value || "new_and_working.nc").trim();

    const url = URL.createObjectURL(convertedBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  clearBtn.addEventListener("click", () => {
    fileEl.value = "";
    inputTa.value = "";
    outputTa.value = "";
    logEl.textContent = "—";
    outnameEl.value = "";
    convertedBlob = null;
    convertBtn.disabled = true;
    downloadBtn.disabled = true;
    setStatus("Waiting for file…", true);
  });
</script>
</body>
</html>
